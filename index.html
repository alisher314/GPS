<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS ART на Яндекс.Картах</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=93cd3342-0be2-4e39-845f-bf0c14234678" type="text/javascript"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #map { width: 100%; height: 100%; }
    .controls {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 10px;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
    }
    button, select {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button { color: white; }
    .pause { background: orange; }
    .resume { background: green; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <button id="pauseBtn" class="pause">⏸ Пауза</button>
    <button id="resumeBtn" class="resume" style="display:none;">▶ Продолжить</button>
    <select id="mapType">
      <option value="yandex#map">Схема</option>
      <option value="yandex#satellite">Спутник</option>
      <option value="yandex#hybrid">Гибрид</option>
    </select>
  </div>
  
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let map, polyline;
    let isPaused = false;
    let lastPointBeforePause = null;

    ymaps.ready(init);

    function init() {
      map = new ymaps.Map("map", {
        center: [55.751244, 37.618423], // Москва по умолчанию
        zoom: 16,
        type: "yandex#map",
        controls: []
      });

      polyline = new ymaps.Polyline([], {}, { strokeColor: '#FF0000', strokeWidth: 4 });
      map.geoObjects.add(polyline);

      // Переключение типа карты
      document.getElementById('mapType').addEventListener('change', (e) => {
        map.setType(e.target.value);
      });

      // GPS отслеживание
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            const currentPoint = [latitude, longitude];
            map.setCenter(currentPoint);

            if (!isPaused) {
              const coords = polyline.geometry.getCoordinates();
              if (lastPointBeforePause) {
                coords.push(lastPointBeforePause);
                coords.push(currentPoint);
                lastPointBeforePause = null;
              } else {
                coords.push(currentPoint);
              }
              polyline.geometry.setCoordinates(coords);
            }
          },
          (err) => console.error(err),
          { enableHighAccuracy: true }
        );
      } else {
        alert("Геолокация не поддерживается вашим устройством.");
      }
    }

    // Кнопки паузы/продолжения
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');

    pauseBtn.addEventListener('click', () => {
      isPaused = true;
      const coords = polyline.geometry.getCoordinates();
      lastPointBeforePause = coords[coords.length - 1] || null;
      pauseBtn.style.display = "none";
      resumeBtn.style.display = "inline-block";
    });

    resumeBtn.addEventListener('click', () => {
      isPaused = false;
      pauseBtn.style.display = "inline-block";
      resumeBtn.style.display = "none";
    });

    // Telegram MainButton
    tg.MainButton.setText("Сохранить GPS ART").show();
    tg.MainButton.onClick(() => {
      const coords = polyline.geometry.getCoordinates();
      tg.sendData(JSON.stringify(coords));
    });
  </script>
</body>
</html>
